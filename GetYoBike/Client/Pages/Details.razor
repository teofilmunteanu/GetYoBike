@page "/details/{bikeTypeNr:int}"


@inject IJSRuntime JsRuntime
@using GetYoBike.Client.Services;
@using GetYoBike.Shared.Models;
@using System.Text.Json;
@inject NavigationManager NavManager
@inject HttpClient Http
@inject Services.RentService RentSvc

@*<header>
    <b><b style="color:#6594EF;">Rent City Bike</b> - Details</b>
</header>*@
<Header Color="#6594EF" Title="Rent City Bike" Subtitle="Details"/>
<div id="grid-container">
    <div class="left">

        <form action="" method="post">
            <div id="div-container">
                <div class="lastName-grid">
                    <label for="Last Name" class="formLabel">Last Name</label>
                    <br />
                    <input type="text" name="Last Name" class="lastName" @bind="LastName">
                </div>
                <div class="firstName-grid">
                    <label for="first Name" class="formLabel">First Name</label>
                    <br />
                    <input type="text" name="First Name" class="firstName" @bind="FirstName">
                </div>
                <div class="email-grid">
                    <label for="email" class="formLabel">Email</label>
                    <br />
                    <input type="email" name="email" class="email" @bind="Email">
                </div>
                <div class="age-grid">
                    <label for="Age" class="formLabel">Age</label>
                    <br />
                    <input type="text" name="Age" class="age" @bind="Age">
                </div>
                <div class="dateStart-grid">
                    <label for="rent" class="formLabel">Start Date</label>
                    <br />
                    <input type="date" name="StartDate" class="rentDate"
                           @bind="RentStartDate" @bind:after="SetDatesAndPrice" />
                </div>
                <div class="timeStart-grid">
                    <label for="duration" class="formLabel">Start Time</label>
                    <br />
                    <input type="time" name="StartTime" class="rentTime" placeholder="hh"
                           @bind="RentStartTime" @bind:after="SetDatesAndPrice">
                </div>
                <div class="dateEnd-grid">
                    <label for="rent" class="formLabel">End Date</label>
                    <br />
                    <input type="date" name="EndDate" class="rentDate"
                           @bind="RentEndDate" @bind:after="SetDatesAndPrice" />
                </div>
                <div class="timeEnd-grid">
                    <label for="duration" class="formLabel">End Time</label>
                    <br />
                    <input type="time" name="EndTime" class="rentTime" placeholder="hh"
                           @bind="RentEndTime" @bind:after="SetDatesAndPrice">
                </div>
                <br />
            </div>
        </form>
    </div>

    <div class="right-top">
        <img src="@SelectedImagePath" class="img-div">
    </div>

    <div class="right-bottom">
        <div class="checkoutItemsContainer">
            <total class="total">
                <span>Total: @Price lei</span>
            </total>
            <button class="button" @onclick="SendToCheckout">
                <span>Checkout </span>
            </button> 
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int bikeTypeNr { get; set; } = 0;

    public string SelectedImagePath { get; set; } = "";
    public decimal Price { get; set; } = 0;
    private decimal pricePerH { get; set; }

    public DateOnly RentStartDate { get; set; }
    public DateOnly RentEndDate { get; set; } 
    public TimeOnly RentStartTime { get; set; }
    public TimeOnly RentEndTime { get; set; }
    public string LastName { get; set; } = "";
    public string FirstName { get; set; } = "";
    public string Email { get; set; } = "";
    public int Age { get; set; }

    DateTime dateTimeStart;
    DateTime dateTimeEnd;

    protected override void OnInitialized()
    {
        LoadSessionForm();
    }

    protected override async Task OnInitializedAsync()
    {
        RentStartDate = DateOnly.FromDateTime(DateTime.Now);
        RentEndDate = DateOnly.FromDateTime(DateTime.Now);
        RentStartTime = TimeOnly.FromDateTime(DateTime.Now);
        RentEndTime = TimeOnly.FromDateTime(DateTime.Now);

        switch (bikeTypeNr)
        {
            case 1:
                SelectedImagePath = "assets/rentCityBike.png";
                break;
            case 2:
                SelectedImagePath = "assets/rentMountainBike.png";
                break;
        }

        BikeTypeModel bikeType = await Http.GetFromJsonAsync<BikeTypeModel>("api/BikeTypes/" + bikeTypeNr);
        pricePerH = bikeType.Price;

        SetDatesAndPrice();
    }

    private void SetDatesAndPrice()
    {
        dateTimeStart = RentStartDate.ToDateTime(new TimeOnly(RentStartTime.Hour, RentStartTime.Minute, 0));
        dateTimeEnd = RentEndDate.ToDateTime(new TimeOnly(RentEndTime.Hour, RentEndTime.Minute, 0));
        RentSvc.SetDuration(dateTimeStart, dateTimeEnd);

        RentSvc.CalculatePrice(RentSvc.DurationHours, pricePerH);
        Price = RentSvc.Price;
    }

    private async void SaveSessionForm(UserModel user, DateTime StartDateTime, DateTime EndDateTime)
    {
        await JsRuntime.InvokeVoidAsync("sessionStorage.setItem", "user", JsonSerializer.Serialize(user));
        await JsRuntime.InvokeVoidAsync("sessionStorage.setItem", "startDateTime", JsonSerializer.Serialize(StartDateTime));
        await JsRuntime.InvokeVoidAsync("sessionStorage.setItem", "endDateTime", JsonSerializer.Serialize(EndDateTime));
    }

    private async void LoadSessionForm()
    {
        string rentUser_json = await JsRuntime.InvokeAsync<string>("sessionStorage.getItem", "user");
        string rentDateStart_json = await JsRuntime.InvokeAsync<string>("sessionStorage.getItem", "startDateTime");
        string rentDateEnd_json = await JsRuntime.InvokeAsync<string>("sessionStorage.getItem", "endDateTime");

        if (!(string.IsNullOrEmpty(rentUser_json) || string.IsNullOrEmpty(rentDateStart_json) || string.IsNullOrEmpty(rentDateEnd_json)))
        {
            UserModel sessionUser = JsonSerializer.Deserialize<UserModel>(rentUser_json);
            Email = sessionUser.Email;
            LastName = sessionUser.LastName;
            FirstName = sessionUser.FirstName;
            Age = sessionUser.Age;

            DateTime sessionDateTimeStart = JsonSerializer.Deserialize<DateTime>(rentDateStart_json);
            DateTime sessionDateTimeEnd = JsonSerializer.Deserialize<DateTime>(rentDateEnd_json);
            RentStartDate = DateOnly.FromDateTime(sessionDateTimeStart);
            RentStartTime = TimeOnly.FromDateTime(sessionDateTimeStart);
            RentEndDate = DateOnly.FromDateTime(sessionDateTimeEnd);
            RentEndTime = TimeOnly.FromDateTime(sessionDateTimeEnd);
        }
    }

    private async void SendToCheckout()
    {
        string message = "";

        if (RentSvc.DurationHours >= RentService.MinRentDuration)
        {
            //if email already used, assign this rent 
            UserModel user = new UserModel
                {
                    //Email = this.Email,
                    //LastName = this.LastName,
                    //FirstName = this.FirstName,
                    //Age = this.Age
                    Email = "mock@email.com",
                    LastName = "last name",
                    FirstName = "first name",
                    Age = 21
                };

            var response = await Http.PostAsJsonAsync("/api/Users/", user);

            if (response.IsSuccessStatusCode)
            {
                string startDateTimeString = dateTimeStart.ToString("yyyy-MM-dd-HH-mm");
                string endDateTimeString = dateTimeEnd.ToString("yyyy-MM-dd-HH-mm");

                var responseContent = response.Content.ReadAsStringAsync().Result;
                var createdUser = JsonSerializer.Deserialize<UserModel>(responseContent, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                SaveSessionForm(user, dateTimeStart, dateTimeEnd);

                NavManager.NavigateTo($"/checkout?userId={createdUser.Id}&type={bikeTypeNr}&startDate={startDateTimeString}&endDate={endDateTimeString}");
            }
            else
            {
                message = response.Content.ReadAsStringAsync().Result;
            }
        }
        else
        {
            message = "Rent duration must be at least" 
            + RentService.MinRentDuration 
            + (RentService.MinRentDuration == 1? " hour" : " hours");
        }

        if(message != "")
        {
            await JsRuntime.InvokeVoidAsync("alert", message);
        }
        
    }
}
